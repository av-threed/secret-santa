<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secret Santa Gift Ideas</title>
  <link rel="stylesheet" href="style.css">
  <script src="supabase.js" type="module"></script>
  <script src="sidebar.js" type="module"></script>
  <style>
    /* Production: two-up grid layout in gift list modals */
    #myGiftsList, #selectedKidGifts {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      align-items: stretch;
    }
    @media (max-width: 700px) {
      #myGiftsList, #selectedKidGifts { grid-template-columns: 1fr; }
    }
    /* Ensure cards fill their grid cell */
    .gift-item { width: 100%; box-sizing: border-box; position: relative; padding-right: 96px; }
    .gift-item .gift-item-actions { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); margin-left: 0 !important; }
    .gift-item .btn-icon { width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; }
    /* Widen gift list modals */
    #myGiftListModal .modal-content, #kidsGiftListModal .modal-content { width: min(1200px, 95vw); max-width: 95vw; max-height: 90vh; overflow: auto; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Gift Lists</h2>
      <button id="sidebarPin" class="sidebar-pin" title="Pin Sidebar">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none">
          <rect x="3" y="3" width="18" height="18" rx="4" stroke="currentColor" stroke-width="2"/>
          <circle cx="12" cy="8" r="1.6" fill="currentColor"/>
          <path d="M12 9.8V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 20l-2.6-4.2h5.2L12 20z" fill="currentColor"/>
        </svg>
      </button>
    </div>
    
    <div class="sidebar-content">
      <button id="myGiftList" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M20,11H4V8H20M20,15H13V13H20M20,19H13V17H20M11,19H4V13H11M20.33,4.67L18.67,3L17,4.67L15.33,3L13.67,4.67L12,3L10.33,4.67L8.67,3L7,4.67L5.33,3L3.67,4.67L2,3V19A2,2 0 0,0 4,21H20A2,2 0 0,0 22,19V3L20.33,4.67Z" />
        </svg>
        My Gift List
      </button>
      
      <button id="kidsGiftList" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z" />
        </svg>
        Kids Gift Lists
      </button>

      <button id="recipientGifts" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12 3C7.58 3 4 6.58 4 11s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8m0 14.5c-2.89 0-5.39-1.64-6.63-4.05.03-2.67 5.33-4.13 6.63-4.13 1.31 0 6.6 1.46 6.63 4.13C17.39 15.86 14.89 17.5 12 17.5m0-9A2.5 2.5 0 1 0 14.5 11 2.5 2.5 0 0 0 12 8.5Z"/>
        </svg>
        Recipient's Gift Ideas
      </button>

      <button id="setRecipient" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12 1a9 9 0 0 1 9 9c0 3.5-2 6.53-4.92 8l.58 3.5L12 19l-4.66 2.5.58-3.5A9.98 9.98 0 0 1 3 10a9 9 0 0 1 9-9m0 4a3 3 0 1 0 3 3 3 3 0 0 0-3-3m0 12c2.67 0 5.33-1.33 6-2-1-2-4-3-6-3s-5 1-6 3c.67.67 3.33 2 6 2Z"/>
        </svg>
        Set Recipient
      </button>

      <button id="settingsBtn" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12,15.5A3.5,3.5 0 1,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.98C19.47,12.66 19.5,12.34 19.5,12C19.5,11.66 19.47,11.34 19.43,11.02L21.54,9.37C21.73,9.22 21.78,8.96 21.66,8.75L19.66,5.25C19.54,5.04 19.28,4.97 19.06,5.05L16.56,6.05C16,5.64 15.39,5.31 14.73,5.07L14.33,2.42C14.29,2.18 14.09,2 13.84,2H10.16C9.91,2 9.71,2.18 9.67,2.42L9.27,5.07C8.61,5.31 8,5.64 7.44,6.05L4.94,5.05C4.72,4.97 4.46,5.04 4.34,5.25L2.34,8.75C2.22,8.96 2.27,9.22 2.46,9.37L4.57,11.02C4.53,11.34 4.5,11.66 4.5,12C4.5,12.34 4.53,12.66 4.57,12.98L2.46,14.63C2.27,14.78 2.22,15.04 2.34,15.25L4.34,18.75C4.46,18.96 4.72,19.03 4.94,18.95L7.44,17.95C8,18.36 8.61,18.69 9.27,18.93L9.67,21.58C9.71,21.82 9.91,22 10.16,22H13.84C14.09,22 14.29,21.82 14.33,21.58L14.73,18.93C15.39,18.69 16,18.36 16.56,17.95L19.06,18.95C19.28,19.03 19.54,18.96 19.66,18.75L21.66,15.25C21.78,15.04 21.73,14.78 21.54,14.63L19.43,12.98Z" />
        </svg>
        Settings
      </button>
    </div>
    
    <button onclick="signOut()" class="sidebar-signout">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" />
      </svg>
      Sign Out
    </button>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div id="welcomeBanner" class="welcome-banner">
      <h1 class="brand-title">Secret Santa</h1>
      <span id="welcomeMessage"></span>
    </div>

    <!-- My Gift List Modal -->
    <div id="myGiftListModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>My Gift List</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="addGiftForm" class="gift-form">
            <input type="text" id="giftName" placeholder="Gift name" required>
            <input type="text" id="giftPrice" placeholder="Price (optional)">
            <input type="text" id="giftLink" placeholder="Link to gift (optional)">
            <textarea id="giftNotes" placeholder="Notes (optional)"></textarea>
            <button type="submit" class="btn-primary">Add Gift</button>
          </form>
          <div id="myGiftsList" class="gifts-list"></div>
        </div>
      </div>
    </div>

    <!-- Kids Gift List Modal -->
    <div id="kidsGiftListModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Kids Gift Lists</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="kids-selector">
            <select id="kidSelector" class="kid-select">
              <option value="">Select a child...</option>
            </select>
          </div>
          <div id="selectedKidGifts" class="gifts-list"></div>
        </div>
      </div>
    </div>

    <!-- Recipient Gifts Modal -->
    <div id="recipientGiftsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Recipient's Gift Ideas</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="recipientHeader" class="helper-text" style="margin-bottom:12px;"></div>
          <div id="recipientGiftsList" class="gifts-list"></div>
        </div>
      </div>
    </div>

    <!-- Set Recipient Modal -->
    <div id="setRecipientModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Choose Your Recipient</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="recipientStatus" class="helper-text" style="margin-bottom:12px;"></div>
          <select id="recipientSelect"></select>
          <button id="saveRecipientBtn" class="btn-primary" style="margin-top:10px;">Save Recipient</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Settings</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="settingsForm" class="settings-form">
            <label class="setting-item">
              <input type="checkbox" id="settingPinSidebar">
              Pin sidebar by default
            </label>
            <div class="setting-item">
              <label for="settingTheme" style="margin: 0;">Theme</label>
              <select id="settingTheme">
                <option value="system">System theme</option>
                <option value="light">Light theme</option>
                <option value="dark">Dark theme</option>
              </select>
            </div>
            <div class="helper-text">These settings are saved on this device.</div>
            <button type="submit" class="btn-primary" style="margin-top:10px;">Save Settings</button>
          </form>
        </div>
      </div>
    </div>

    <div class="main-forms-container">
    <!-- Adult Gift Form -->
    <form id="adultGiftForm" class="gift-form adult-form">
      <h3 class="form-title">Your Gift Ideas</h3>
      <p class="helper-text">Add gift ideas you would like to receive. Only you can submit ideas for yourself.</p>
      <!-- Submission mode toggle -->
      <div id="devSubmissionMode" class="form-group" style="margin: 8px 0 12px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-weight:600;">Add as:</span>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="radio" name="devMode" value="idea" checked>
          Idea
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="radio" name="devMode" value="link">
          Link
        </label>
      </div>
      <div id="devIdeaModeFields">
        <label for="adultGiftIdeas">Gift Ideas for You:</label>
        <textarea id="adultGiftIdeas" name="giftIdeas" rows="12" required></textarea>
      </div>
      <div id="devLinkModeFields" class="form-group" style="display:none;">
        <label for="devLinkUrl">Product link (http/https):</label>
        <input type="url" id="devLinkUrl" placeholder="https://example.com/product" pattern="https?://.*">
        <label for="devLinkCaption" style="margin-top:8px;">Optional caption/title:</label>
        <input type="text" id="devLinkCaption" placeholder="e.g., LEGO City Fire Truck">
      </div>
      <button type="submit" class="submit-btn">Add My Gift Ideas</button>
    </form>

    <!-- Kids Gift Form -->
    <form id="kidsGiftForm" class="gift-form kids-form">
      <h3 class="form-title">Suggest Gift Ideas for Kids</h3>
      <p class="helper-text">Help build a gift suggestion list for the little ones! Other family members can use these ideas for shopping.</p>
      
      <div class="form-group">
        <label for="childSelect">Which child are these ideas for?</label>
        <select id="childSelect" name="childName" required>
          <option value="">Select a child...</option>
        </select>
        <button type="button" id="addChildBtn" class="btn-secondary" style="margin-left:8px">+ Add child</button>
      </div>

      <!-- Kids submission mode toggle -->
      <div id="devKidsSubmissionMode" class="form-group" style="margin: 8px 0 12px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-weight:600;">Add as:</span>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="radio" name="devKidsMode" value="idea" checked>
          Idea
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="radio" name="devKidsMode" value="link">
          Link
        </label>
      </div>
      <div id="devKidsIdeaFields" class="form-group">
        <label for="kidsGiftIdeas">Gift Ideas for Selected Child:</label>
        <textarea id="kidsGiftIdeas" name="giftIdeas" rows="4" placeholder="Enter gift suggestions for this child (one per line)...&#13;&#10;Examples:&#13;&#10;- Dinosaur toys&#13;&#10;- Size 4T winter clothes&#13;&#10;- Educational books&#13;&#10;- Favorite characters: Paw Patrol, PJ Masks" required></textarea>
      </div>
      <div id="devKidsLinkFields" class="form-group" style="display:none;">
        <label for="devKidLinkUrl">Product link (http/https):</label>
        <input type="url" id="devKidLinkUrl" placeholder="https://example.com/product" pattern="https?://.*">
        <label for="devKidLinkCaption" style="margin-top:8px;">Optional caption/title:</label>
        <input type="text" id="devKidLinkCaption" placeholder="e.g., LEGO City Fire Truck">
      </div>

      <div class="tips-section">
        <h4 class="tips-title">Helpful details to include:</h4>
        <ul>
          <li>Sizes for clothes/shoes</li>
          <li>Favorite characters or themes</li>
          <li>Specific toys or brands they like</li>
          <li>Things they already have (to avoid duplicates)</li>
        </ul>
      </div>

      <button type="submit" class="submit-btn">Add Gift Suggestions</button>
    </form>
  </div>

  <!-- SVG Icons Container -->
  <div class="svg-container">
    <object type="image/svg+xml" data="sidebar-icons.svg"></object>
  </div>

  <!-- Environment Variables (Replace these with your Supabase project values) -->
  <script>
    window.env = {
      SUPABASE_URL: 'your-supabase-url',
      SUPABASE_KEY: 'your-supabase-key'
    };
  </script>

  <!-- Application Scripts -->
  <script type="module" src="auth.js"></script>
  <script type="module" src="app.js"></script>
  <!-- Production script: link mode, link cards, edit modal, claim/unclaim (includes offline fallback) -->
  <script type="module">
    import { supabase, addGiftToList, getCurrentUser, getMyGifts, addKidGift, getKidGifts, deleteKidGift } from './supabase.js';
    import { showToast, confirmDialog, editGiftDialog } from './ui.js';

    const adultForm = document.getElementById('adultGiftForm');
    const modeWrap = document.getElementById('devSubmissionMode');
    const ideaFields = document.getElementById('devIdeaModeFields');
    const linkFields = document.getElementById('devLinkModeFields');
    const urlInput = document.getElementById('devLinkUrl');
    const captionInput = document.getElementById('devLinkCaption');
    const ideaTextarea = document.getElementById('adultGiftIdeas');
    const myGiftListBtn = document.getElementById('myGiftList');
    const myGiftsList = document.getElementById('myGiftsList');
    const kidsForm = document.getElementById('kidsGiftForm');
    const childSelect = document.getElementById('childSelect');
    const kidsListBtn = document.getElementById('kidsGiftList');
    const kidSelectorInModal = document.getElementById('kidSelector');
    const selectedKidGifts = document.getElementById('selectedKidGifts');
    const kidsModeWrap = document.getElementById('devKidsSubmissionMode');
    const kidsIdeaFields = document.getElementById('devKidsIdeaFields');
    const kidsLinkFields = document.getElementById('devKidsLinkFields');
    const kidUrlInput = document.getElementById('devKidLinkUrl');
    const kidCaptionInput = document.getElementById('devKidLinkCaption');
    const kidsTextarea = document.getElementById('kidsGiftIdeas');

    function getSelectedMode() { const checked = modeWrap?.querySelector('input[name="devMode"]:checked'); return checked ? checked.value : 'idea'; }
    function setModeUI(mode) {
      if (!ideaFields || !linkFields) return;
      if (mode === 'link') { ideaFields.style.display = 'none'; linkFields.style.display = ''; if (ideaTextarea) ideaTextarea.required = false; if (urlInput) urlInput.required = true; }
      else { ideaFields.style.display = ''; linkFields.style.display = 'none'; if (ideaTextarea) ideaTextarea.required = true; if (urlInput) urlInput.required = false; }
    }
    modeWrap?.addEventListener('change', () => setModeUI(getSelectedMode())); setModeUI(getSelectedMode());

    function normalizeUrl(inputUrl) { try { const u = new URL(inputUrl); if (!/^https?:$/.test(u.protocol)) return null; const strip=[/^utm_/i,/^fbclid$/i,/^gclid$/i,/^igshid$/i,/^mc_eid$/i,/^mc_cid$/i,/^ref$/i]; [...u.searchParams.keys()].forEach(k=>{ if(strip.some(r=>r.test(k))) u.searchParams.delete(k);}); const host=u.hostname.replace(/^www\./,''); if(host.includes('amazon.')){ const m=u.pathname.match(/(?:dp|gp\/product)\/([A-Z0-9]{10})/i)||u.pathname.match(/\/([A-Z0-9]{10})(?:[/?]|$)/i); if(m&&m[1]){ u.pathname=`/dp/${m[1].toUpperCase()}`; u.search=''; } u.searchParams.delete('tag'); } u.protocol='https:'; return u.toString(); } catch{ return null; } }

    // Adult submit: Link mode override
    adultForm?.addEventListener('submit', async (e) => {
      if (getSelectedMode() !== 'link') return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
      const rawUrl = (urlInput?.value || '').trim(); if (!rawUrl) { showToast('Enter a product link', 'error'); return; }
      const normalized = normalizeUrl(rawUrl); if (!normalized) { showToast('Enter a valid http/https link', 'error'); return; }
      const caption = (captionInput?.value || '').trim();
      try {
        const user = await getCurrentUser().catch(() => null);
        if (user && user.id) { const name = caption || new URL(normalized).hostname.replace(/^www\./,''); await addGiftToList({ name, link: normalized }); showToast('Link added'); }
        else {
          const display = caption ? `${caption} (${normalized})` : normalized; const existing = JSON.parse(localStorage.getItem('my_gift_ideas') || '[]'); existing.push(display); localStorage.setItem('my_gift_ideas', JSON.stringify(existing)); showToast('Link added locally');
        }
        if (urlInput) urlInput.value = ''; if (captionInput) captionInput.value = ''; window.dispatchEvent(new CustomEvent('my-gifts-updated'));
      } catch(err){ console.error(err); showToast('Failed to add link', 'error'); }
    }, true);

    // Kids: mode switch
    function getSelectedKidsMode(){ const c = kidsModeWrap?.querySelector('input[name="devKidsMode"]:checked'); return c ? c.value : 'idea'; }
    function setKidsModeUI(mode){ if(!kidsIdeaFields||!kidsLinkFields) return; if(mode==='link'){ kidsIdeaFields.style.display='none'; kidsLinkFields.style.display=''; if(kidsTextarea) kidsTextarea.required=false; if(kidUrlInput) kidUrlInput.required=true; } else { kidsIdeaFields.style.display=''; kidsLinkFields.style.display='none'; if(kidsTextarea) kidsTextarea.required=true; if(kidUrlInput) kidUrlInput.required=false; } }
    kidsModeWrap?.addEventListener('change', ()=> setKidsModeUI(getSelectedKidsMode())); setKidsModeUI(getSelectedKidsMode());

    // Kids submit: Link mode override
    kidsForm?.addEventListener('submit', async (e)=>{
      const mode = getSelectedKidsMode();
      if(mode !== 'link') {
        // Idea mode: if not signed in, save locally so you can test offline
        try {
          const user = await getCurrentUser().catch(()=>null);
          if (user && user.id) return; // let app.js handle DB path
        } catch {}
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
        const kidId = childSelect?.value || '';
        if (!kidId) { showToast('Select a child', 'error'); return; }
        const raw = (kidsTextarea?.value || '').trim();
        if (!raw) { showToast('Enter at least one idea', 'error'); return; }
        const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
        try {
          const key = localKeyForKid(kidId);
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          lines.forEach(line => { if (!arr.includes(line)) arr.push(line); });
          localStorage.setItem(key, JSON.stringify(arr));
          if (kidsTextarea) kidsTextarea.value = '';
          showToast('Suggestions added (local)');
          window.dispatchEvent(new CustomEvent('kid-gifts-updated',{detail:{kidId}}));
        } catch(err){ console.error(err); showToast('Failed to save locally','error'); }
        return;
      }
      // Link mode override
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
      const kidId = childSelect?.value || ''; if(!kidId){ showToast('Select a child', 'error'); return; }
      const rawUrl = (kidUrlInput?.value||'').trim(); if(!rawUrl){ showToast('Enter a product link', 'error'); return; }
      const normalized = normalizeUrl(rawUrl); if(!normalized){ showToast('Enter a valid http/https link', 'error'); return; }
      const caption = (kidCaptionInput?.value||'').trim(); const name = `${caption || (new URL(normalized)).hostname.replace(/^www\./,'')} (${normalized})`;
      try{ const user = await getCurrentUser().catch(()=>null); if(user&&user.id){ await addKidGift(kidId,{name}); } else { const key=`kid_gifts_local:${kidId}`; const arr=JSON.parse(localStorage.getItem(key)||'[]'); if(!arr.includes(name)) arr.push(name); localStorage.setItem(key, JSON.stringify(arr)); }
        if(kidUrlInput) kidUrlInput.value=''; if(kidCaptionInput) kidCaptionInput.value=''; showToast('Link added'); window.dispatchEvent(new CustomEvent('kid-gifts-updated',{detail:{kidId}})); } catch(err){ console.error(err); showToast('Failed to add link', 'error'); }
    }, true);

    // Helpers for local claims
    function localKeyForKid(k){ return `kid_gifts_local:${k}`; }
    function localClaimKeyForKid(k){ return `kid_gifts_claims:${k}`; }
    function getLocalClaimSet(k){ try{ return new Set(JSON.parse(localStorage.getItem(localClaimKeyForKid(k))||'[]')); }catch{ return new Set(); } }
    function saveLocalClaimSet(k,set){ try{ localStorage.setItem(localClaimKeyForKid(k), JSON.stringify(Array.from(set))); }catch{} }
    function getLocalKidGifts(k){ try{ const arr=JSON.parse(localStorage.getItem(localKeyForKid(k))||'[]'); const claims=getLocalClaimSet(k); return arr.map(n=>{ const raw=String(n); const link=(raw.match(/\((https?:[^)]+)\)$/i)||[])[1]||null; const claimed_by=claims.has(raw)?'local':null; return { id:`local-kid-${k}-${encodeURIComponent(raw)}`, name: raw, link, claimed_by, local_key: raw }; }); }catch{ return []; } }

    function domainFromUrl(h){ try{ return new URL(h).hostname.replace(/^www\./,''); }catch{ return ''; } }

    async function loadMyGiftsProd(){ /* reuse sidebar behavior: trigger refresh */ }

    // Note: Kids modal rendering and actions are handled by sidebar.js to avoid duplicate listeners
  </script>
</body>
</html>

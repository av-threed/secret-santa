<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secret Santa Gift Ideas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #e53935 0%, #43a047 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .hidden { display: none !important; }
    .auth-container {
      max-width: 500px;
      margin: 40px auto;
      background: #fffbe7;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(44, 62, 80, 0.15);
      border: 2px solid #c62828;
      text-align: center;
    }
    .auth-container input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1.5px solid #c62828;
      font-size: 1em;
      background: #fff;
      color: #222;
      box-sizing: border-box;
    }
    .auth-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    .auth-buttons p {
      margin: 0;
    }
    .link-button {
      background: none;
      border: none;
      color: #388e3c;
      padding: 0;
      font: inherit;
      cursor: pointer;
      text-decoration: underline;
      margin: 0 0 0 5px;
      box-shadow: none;
    }
    .link-button:hover {
      background: none;
      color: #2e7d32;
    }
    .error {
      color: #c62828;
      margin: 10px 0;
      font-weight: bold;
    }
    h1 {
      background-color: #388e3c;
      color: #fffbe7;
      padding: 24px;
      margin: 0;
      text-align: center;
      letter-spacing: 2px;
      border-bottom: 6px solid #c62828;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    form {
      max-width: 500px;
      margin: 40px auto;
      background: #fffbe7;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(44, 62, 80, 0.15);
      border: 2px solid #c62828;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
      color: #388e3c;
    }
    select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1.5px solid #c62828;
      font-size: 1em;
      background: #fff;
      color: #222;
      box-sizing: border-box;
    }
    button {
      margin-top: 28px;
      background: linear-gradient(90deg, #c62828 60%, #388e3c 100%);
      color: #fffbe7;
      border: none;
      padding: 14px 28px;
      border-radius: 6px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.10);
      transition: background 0.2s;
    }
    button:hover {
      background: linear-gradient(90deg, #b71c1c 60%, #2e7d32 100%);
    }
    .submissions {
      max-width: 650px;
      margin: 40px auto 0 auto;
      background: #fffbe7;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(44, 62, 80, 0.13);
      border: 2px solid #388e3c;
    }
    .submissions h2 {
      color: #c62828;
      margin-top: 0;
      margin-bottom: 18px;
      letter-spacing: 1px;
    }
    .form-section {
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    .form-section h3 {
      color: #388e3c;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .helper-text {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 15px;
    }
    .suggestion-tips {
      background: rgba(56, 142, 60, 0.1);
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }
    .suggestion-tips p {
      margin: 0 0 10px 0;
      color: #388e3c;
      font-weight: bold;
    }
    .suggestion-tips ul {
      margin: 0;
      padding-left: 20px;
      color: #666;
    }
    .kids-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .kid-filter-btn {
      background: #fff;
      border: 2px solid #c62828;
      color: #c62828;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .kid-filter-btn:hover {
      background: #c62828;
      color: #fff;
    }
    .kid-filter-btn.active {
      background: #c62828;
      color: #fff;
    }
    .submissions-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    @media (min-width: 1024px) {
      .submissions-container {
        grid-template-columns: 1fr 1fr;
      }
    }
    .submission {
      border-bottom: 1.5px dashed #c62828;
      padding: 18px 0;
    }
    .submission:last-child {
      border-bottom: none;
    }
    .submission h3 {
      margin: 0 0 8px 0;
      color: #388e3c;
      font-size: 1.1em;
      font-weight: bold;
    }
    .submission p {
      margin: 0;
      white-space: pre-line;
      color: #222;
    }
    /* Festive icon */
    .tree {
      display: block;
      margin: 0 auto 18px auto;
      font-size: 2.5em;
      text-align: center;
      filter: drop-shadow(0 2px 4px rgba(44,62,80,0.10));
    }
  </style>
</head>
<body>
  <!-- Environment Variables (Replace these with your Supabase project values) -->
  <script>
    window.env = {
      SUPABASE_URL: 'https://icdxxlirmwhbehqqrhot.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljZHh4bGlybXdoYmVocXFyaG90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Mzk5NTEsImV4cCI6MjA3MjAxNTk1MX0.VN6nr8wFdUe16nB5f7nzwC7iOcbwgBIcnsM7nLFRWhY'
    };
  </script>

  <!-- Auth Container -->
  <div id="authContainer" class="auth-container">
    <div class="tree">🎄</div>
    <h1>Secret Santa Gift Ideas</h1>
    <div id="signInForm">
      <h3>Sign In</h3>
      <input type="email" id="emailInput" placeholder="Your email">
      <input type="password" id="passwordInput" placeholder="Your password">
      <div class="auth-buttons">
        <button onclick="signIn()">Sign In</button>
        <p>Don't have an account? <button onclick="toggleForms()" class="link-button">Sign Up</button></p>
      </div>
    </div>
    <div id="signUpForm" class="hidden">
      <h3>Sign Up</h3>
      <input type="text" id="fullNameInput" placeholder="Your full name">
      <input type="email" id="signUpEmailInput" placeholder="Your email">
      <input type="password" id="signUpPasswordInput" placeholder="Choose a password">
      <div class="auth-buttons">
        <button onclick="signUp()">Sign Up</button>
        <p>Already have an account? <button onclick="toggleForms()" class="link-button">Sign In</button></p>
      </div>
    </div>
    <div id="authError" class="error hidden"></div>
  </div>

  <!-- Main Content (hidden until authenticated) -->
  <div id="mainContent" class="hidden">
    <div class="tree">🎄</div>
    <h1>Secret Santa Gift Ideas</h1>
    <div id="userInfo" style="text-align: center; color: #fffbe7; margin-bottom: 20px;">
      <span id="welcomeMessage"></span>
      <button onclick="signOut()" style="margin-left: 20px;">Sign Out</button>
    </div>
    <!-- Adult Gift Ideas Form (Only visible when logged in) -->
    <form id="giftForm" class="hidden">
      <div class="form-section">
        <h3>Submit Your Gift Ideas</h3>
        <label for="ideas">Gift Ideas You'd Like to Receive:</label>
        <textarea id="ideas" name="ideas" rows="5" placeholder="Enter your gift ideas here..." required></textarea>
        <button type="submit">Submit My Ideas</button>
      </div>
    </form>

    <!-- Kids Gift Ideas Form (Always visible) -->
    <form id="kidsGiftForm">
      <div class="form-section">
        <h3>Suggest Gift Ideas for Kids</h3>
        <p class="helper-text">Help build a gift suggestion list for the little ones! Other family members can use these ideas for shopping.</p>
        
        <label for="kidSelect">Which child are these ideas for?</label>
        <select id="kidSelect" name="kidSelect" required>
          <option value="">Choose a child...</option>
          <!-- Kids will be loaded dynamically -->
        </select>
        
        <label for="kidIdeas">Gift Ideas for Selected Child:</label>
        <textarea id="kidIdeas" name="kidIdeas" rows="5" 
          placeholder="Enter gift suggestions for this child (one per line)... 
Examples:
- Dinosaur toys
- Size 4T winter clothes
- Educational books
- Favorite characters: Paw Patrol, PJ Masks" required></textarea>

        <div class="suggestion-tips">
          <p>💡 Helpful details to include:</p>
          <ul>
            <li>Sizes for clothes/shoes</li>
            <li>Favorite characters or themes</li>
            <li>Specific toys or brands they like</li>
            <li>Things they already have (to avoid duplicates)</li>
          </ul>
        </div>

        <button type="submit">Add Gift Suggestions</button>
      </div>
    </form>

  <div class="submissions-container">
    <!-- Kids Gift Ideas Section (Always visible) -->
    <div class="submissions" id="kidSubmissions">
      <h2>Kids' Gift Ideas</h2>
      <p class="helper-text">Gift suggestions from family members for the kids. Click a child's name to see their suggestions.</p>
      <div class="kids-filter">
        <button class="kid-filter-btn active" data-kid="all">All Kids</button>
        <!-- Kid filter buttons will be added dynamically -->
      </div>
      <div id="kidIdeasList">
        <!-- Kid submissions will appear here -->
      </div>
    </div>

    <!-- Adult Gift Ideas Section (Only visible when logged in) -->
    <div class="submissions hidden" id="adultSubmissions">
      <h2>Adult Gift Ideas</h2>
      <p class="helper-text">Gift ideas submitted by family members for themselves.</p>
      <!-- Adult submissions will appear here -->
    </div>
  </div>

  <script type="module">
    import { supabase, signUpWithEmail, signInWithEmail, signOut, getSession } 
    from './supabaseClient.js';

    // Make functions available globally
    window.supabase = supabase;
    window.signUpWithEmail = signUpWithEmail;
    window.signInWithEmail = signInWithEmail;
    window.signOut = signOut;
    window.getSession = getSession;

    // Show/hide auth forms
    window.toggleForms = () => {
      document.getElementById('signInForm').classList.toggle('hidden');
      document.getElementById('signUpForm').classList.toggle('hidden');
      document.getElementById('authError').classList.add('hidden');
    };

    // Sign in handler
    window.signIn = async () => {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      
      try {
        const { data, error } = await signInWithEmail(email, password);
        if (error) throw error;
        await loadUserData();
      } catch (error) {
        document.getElementById('authError').textContent = error.message;
        document.getElementById('authError').classList.remove('hidden');
      }
    };

    // Sign up handler
    window.signUp = async () => {
      const email = document.getElementById('signUpEmailInput').value;
      const password = document.getElementById('signUpPasswordInput').value;
      const fullName = document.getElementById('fullNameInput').value;
      
      try {
        const { data, error } = await signUpWithEmail(email, password);
        if (error) throw error;
        
        // Create profile
        const { error: profileError } = await supabase
          .from('profiles')
          .insert([{ id: data.user.id, full_name: fullName }]);
        
        if (profileError) throw profileError;
        
        document.getElementById('authError').textContent = 'Sign up successful! Please check your email for confirmation.';
        document.getElementById('authError').classList.remove('hidden');
      } catch (error) {
        document.getElementById('authError').textContent = error.message;
        document.getElementById('authError').classList.remove('hidden');
      }
    };

    // Load kids from Supabase
    async function loadKids() {
      try {
        const { data: currentYear } = await supabase
          .from('app_settings')
          .select('value')
          .eq('key', 'current_year')
          .single();
        
        const { data: kids, error } = await supabase
          .from('kids')
          .select('id, name')
          .eq('year', currentYear.value)
          .order('name');
        
        if (error) throw error;

        const kidSelect = document.getElementById('kidSelect');
        kidSelect.innerHTML = '<option value="">Select a child...</option>' +
          kids.map(kid => `<option value="${kid.id}">${kid.name}</option>`).join('');
      } catch (error) {
        console.error('Error loading kids:', error);
      }
    }

    // Load submissions from Supabase
    async function loadSubmissions() {
      try {
        const { data: currentYear } = await supabase
          .from('app_settings')
          .select('value')
          .eq('key', 'current_year')
          .single();
        
        // Load adult ideas
        const { data: adultIdeas, error: adultError } = await supabase
          .from('ideas')
          .select(`
            id,
            idea_text,
            profiles:author_user_id (full_name)
          `)
          .eq('year', currentYear.value)
          .is('kid_id', null);
        
        if (adultError) throw adultError;

        // Load kid ideas
        const { data: kidIdeas, error: kidError } = await supabase
          .from('ideas')
          .select(`
            id,
            idea_text,
            kid_id,
            kids:kid_id (name),
            profiles:author_user_id (full_name)
          `)
          .eq('year', currentYear.value)
          .not('kid_id', 'is', null);

        if (kidError) throw kidError;

        // Display adult ideas
        const adultSubmissionsDiv = document.getElementById('adultSubmissions');
        let adultHtml = '';
        
        if (adultIdeas.length === 0) {
          adultHtml = '<p style="color:#888;">No adult gift ideas submitted yet.</p>';
        } else {
          adultIdeas.forEach(idea => {
            adultHtml += `
              <div class="submission">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <span>
                    <span style="font-size:1.2em;">🎁</span>
                    <span style="color:#388e3c; font-weight:bold;">${idea.profiles.full_name}</span>
                  </span>
                  <button class="edit-btn" data-id="${idea.id}" data-type="adult"
                    style="background:none; border:none; color:#b71c1c; cursor:pointer; font-size:0.85em; opacity:0.7; padding:2px 8px; border-radius:4px; transition:background 0.2s;"
                    onmouseover="this.style.background='#f8d7da';" 
                    onmouseout="this.style.background='none';">
                    Edit
                  </button>
                </div>
                <p>${idea.idea_text.replace(/\n/g, '<br>')}</p>
              </div>
            `;
          });
        }
        
        // Display kid ideas
        const kidSubmissionsDiv = document.getElementById('kidSubmissions');
        let kidHtml = '';
        
        if (kidIdeas.length === 0) {
          kidHtml = '<p style="color:#888;">No kid gift ideas submitted yet.</p>';
        } else {
          kidIdeas.forEach(idea => {
            kidHtml += `
              <div class="submission">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <span>
                    <span style="font-size:1.2em;">�</span>
                    <span style="color:#388e3c; font-weight:bold;">${idea.kids.name}</span>
                    <span style="color:#666; font-size:0.9em;">(added by ${idea.profiles.full_name})</span>
                  </span>
                  <button class="edit-btn" data-id="${idea.id}" data-type="kid"
                    style="background:none; border:none; color:#b71c1c; cursor:pointer; font-size:0.85em; opacity:0.7; padding:2px 8px; border-radius:4px; transition:background 0.2s;"
                    onmouseover="this.style.background='#f8d7da';" 
                    onmouseout="this.style.background='none';">
                    Edit
                  </button>
                </div>
                <p>${idea.idea_text.replace(/\n/g, '<br>')}</p>
              </div>
            `;
          });
        }
        
        adultSubmissionsDiv.innerHTML = '<h2>Adult Gift Ideas</h2>' + adultHtml;
        kidSubmissionsDiv.innerHTML = '<h2>Kids Gift Ideas</h2>' + kidHtml;

        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const ideaId = this.getAttribute('data-id');
            const { data: idea, error } = await supabase
              .from('ideas')
              .select('idea_text')
              .eq('id', ideaId)
              .single();
            
            if (error) {
              console.error('Error fetching idea:', error);
              return;
            }
            
            document.getElementById('ideas').value = idea.idea_text;
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        });
      } catch (error) {
        console.error('Error loading submissions:', error);
      }
    }

    // Handle form submission
    document.getElementById('giftForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const adultIdeas = document.getElementById('ideas').value.trim();
      const kidIdeas = document.getElementById('kidIdeas').value.trim();
      const selectedKidId = document.getElementById('kidSelect').value;
      
      if (!adultIdeas && (!kidIdeas || !selectedKidId)) {
        alert('Please enter some gift ideas');
        return;
      }

      try {
        const { data: { session } } = await getSession();
        if (!session) {
          alert('Please sign in first');
          return;
        }

        const { data: currentYear } = await supabase
          .from('app_settings')
          .select('value')
          .eq('key', 'current_year')
          .single();

        // Submit adult ideas if provided
        if (adultIdeas) {
          const { error: adultError } = await supabase
            .from('ideas')
            .insert([{
              year: currentYear.value,
              recipient_user_id: session.user.id,
              author_user_id: session.user.id,
              idea_text: adultIdeas
            }]);

          if (adultError) throw adultError;
        }

        // Submit kid ideas if provided
        if (kidIdeas && selectedKidId) {
          const { error: kidError } = await supabase
            .from('ideas')
            .insert([{
              year: currentYear.value,
              kid_id: selectedKidId,
              author_user_id: session.user.id,
              idea_text: kidIdeas
            }]);

          if (kidError) throw kidError;
        }
        
        this.reset();
        await loadSubmissions();
      } catch (error) {
        console.error('Error submitting idea:', error);
        alert('Error submitting idea. Please try again.');
      }
    });

    // Load user data and show main content
    async function loadUserData() {
      const { data: { session } } = await getSession();
      if (session) {
        const { data: profile } = await supabase
          .from('profiles')
          .select('full_name')
          .eq('id', session.user.id)
          .single();
        
        document.getElementById('welcomeMessage').textContent = `Welcome, ${profile?.full_name || 'User'}!`;
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        await loadSubmissions();
      } else {
        document.getElementById('authContainer').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
      }
    }

    // Load kids list initially
    loadKids();
    
    // Check for initial session
    loadUserData();

    // Listen for auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        loadUserData();
      } else if (event === 'SIGNED_OUT') {
        document.getElementById('authContainer').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secret Santa Gift Ideas</title>
  <link rel="stylesheet" href="style.css">
  <script src="supabase.js" type="module"></script>
  <script src="sidebar.js" type="module"></script>
  <style>
    /* Production: two-up grid layout in gift list modals */
    #myGiftsList, #selectedKidGifts, #shoppingListContainer {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      align-items: stretch;
    }
    @media (max-width: 700px) {
      #myGiftsList, #selectedKidGifts, #shoppingListContainer { grid-template-columns: 1fr; }
    }
    
    /* Ensure cards fill their grid cell and buttons are always visible */
    .gift-item { 
      width: 100%; 
      box-sizing: border-box; 
      position: relative; 
      padding-right: 80px; /* Space for buttons */
      min-height: 60px; /* Ensure minimum height for button alignment */
    }
    
    .gift-item .gift-item-info {
      max-width: 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }
    
    .gift-item .gift-item-info h3,
    .gift-item .gift-item-info p {
      max-width: 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
    }
    
    .gift-item .gift-item-actions { 
      position: absolute; 
      right: 8px; 
      top: 50%; 
      transform: translateY(-50%); 
      margin-left: 0 !important;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 10;
    }
    
    .gift-item .btn-icon { 
      width: 32px; 
      height: 32px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      flex-shrink: 0;
    }
    
    /* Mobile: stack buttons vertically and ensure text doesn't overlap */
    @media (max-width: 600px) {
      .gift-item { 
        padding-right: 48px; /* Narrower button area on mobile */
        min-height: 70px;
      }
      
      .gift-item .gift-item-actions {
        right: 6px;
        gap: 4px;
      }
      
      .gift-item .btn-icon {
        width: 36px;
        height: 36px;
      }
      
      /* Ensure text has proper margin on mobile */
      .gift-item .gift-item-info {
        padding-right: 4px;
      }
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
</head>
<body>
  <button id="mobileMenuBtn" class="hamburger" aria-label="Open menu">â˜°</button>
  <div id="sidebarBackdrop" class="sidebar-backdrop"></div>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Gift Lists</h2>
      <button id="sidebarPin" class="sidebar-pin" title="Pin Sidebar">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none">
          <rect x="3" y="3" width="18" height="18" rx="4" stroke="currentColor" stroke-width="2"/>
          <circle cx="12" cy="8" r="1.6" fill="currentColor"/>
          <path d="M12 9.8V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 20l-2.6-4.2h5.2L12 20z" fill="currentColor"/>
        </svg>
      </button>
    </div>
    
    <div class="sidebar-content">
      <button id="myGiftList" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M20,11H4V8H20M20,15H13V13H20M20,19H13V17H20M11,19H4V13H11M20.33,4.67L18.67,3L17,4.67L15.33,3L13.67,4.67L12,3L10.33,4.67L8.67,3L7,4.67L5.33,3L3.67,4.67L2,3V19A2,2 0 0,0 4,21H20A2,2 0 0,0 22,19V3L20.33,4.67Z" />
        </svg>
        My Gift List
      </button>
      
      <button id="kidsGiftList" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z" />
        </svg>
        Kids Gift Lists
      </button>

      <button id="shoppingListBtn" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2m10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2M7.2 14h9.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48a1 1 0 0 0-1-1H6.21L5.27 2.9A1 1 0 0 0 4.34 2H2v2h1.6l3.6 7.59L5.25 14.04A2 2 0 0 0 7.2 18H19v-2H7.42l1.1-2z" />
        </svg>
        Shopping List
      </button>

      <button id="recipientGifts" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12 3C7.58 3 4 6.58 4 11s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8m0 14.5c-2.89 0-5.39-1.64-6.63-4.05.03-2.67 5.33-4.13 6.63-4.13 1.31 0 6.6 1.46 6.63 4.13C17.39 15.86 14.89 17.5 12 17.5m0-9A2.5 2.5 0 1 0 14.5 11 2.5 2.5 0 0 0 12 8.5Z"/>
        </svg>
        Recipient's Gift Ideas
      </button>

      <button id="setRecipient" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12 1a9 9 0 0 1 9 9c0 3.5-2 6.53-4.92 8l.58 3.5L12 19l-4.66 2.5.58-3.5A9.98 9.98 0 0 1 3 10a9 9 0 0 1 9-9m0 4a3 3 0 1 0 3 3 3 3 0 0 0-3-3m0 12c2.67 0 5.33-1.33 6-2-1-2-4-3-6-3s-5 1-6 3c.67.67 3.33 2 6 2Z"/>
        </svg>
        Set Recipient
      </button>

      <button id="settingsBtn" class="sidebar-button">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12,15.5A3.5,3.5 0 1,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.98C19.47,12.66 19.5,12.34 19.5,12C19.5,11.66 19.47,11.34 19.43,11.02L21.54,9.37C21.73,9.22 21.78,8.96 21.66,8.75L19.66,5.25C19.54,5.04 19.28,4.97 19.06,5.05L16.56,6.05C16,5.64 15.39,5.31 14.73,5.07L14.33,2.42C14.29,2.18 14.09,2 13.84,2H10.16C9.91,2 9.71,2.18 9.67,2.42L9.27,5.07C8.61,5.31 8,5.64 7.44,6.05L4.94,5.05C4.72,4.97 4.46,5.04 4.34,5.25L2.34,8.75C2.22,8.96 2.27,9.22 2.46,9.37L4.57,11.02C4.53,11.34 4.5,11.66 4.5,12C4.5,12.34 4.53,12.66 4.57,12.98L2.46,14.63C2.27,14.78 2.22,15.04 2.34,15.25L4.34,18.75C4.46,18.96 4.72,19.03 4.94,18.95L7.44,17.95C8,18.36 8.61,18.69 9.27,18.93L9.67,21.58C9.71,21.82 9.91,22 10.16,22H13.84C14.09,22 14.29,21.82 14.33,21.58L14.73,18.93C15.39,18.69 16,18.36 16.56,17.95L19.06,18.95C19.28,19.03 19.54,18.96 19.66,18.75L21.66,15.25C21.78,15.04 21.73,14.78 21.54,14.63L19.43,12.98Z" />
        </svg>
        Settings
      </button>

      <button id="adminPortalBtn" class="sidebar-button" style="display:none;">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12 1L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-4m0 2.2l6.8 3.1v4.8c0 4.1-2.6 7.9-6.8 9.2-4.2-1.3-6.8-5.1-6.8-9.2V6.3L12 3.2M12 7a3 3 0 0 0-3 3 3 3 0 0 0 6 0 3 3 0 0 0-3-3m0 8c-2.67 0-5.33 1.33-6 2 .67 1.33 3.33 2 6 2s5.33-.67 6-2c-.67-.67-3.33-2-6-2z" />
        </svg>
        Admin
      </button>
    </div>
    
    <button onclick="signOut()" class="sidebar-signout">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" />
      </svg>
      Sign Out
    </button>
  </aside>
  
  <!-- Modals (placed at body level to ensure full-viewport coverage) -->
  <!-- My Gift List Modal -->
  <div id="myGiftListModal" class="modal modal--wide">
    <div class="modal-content">
      <div class="modal-header">
        <h2>My Gift List</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="addGiftForm" class="gift-form">
          <input type="text" id="giftName" placeholder="Gift name" required>
          <input type="text" id="giftPrice" placeholder="Price (optional)">
          <input type="url" id="giftLink" placeholder="Link to gift (optional)">
          <textarea id="giftNotes" placeholder="Notes (optional)"></textarea>
          <button type="submit" class="btn-primary">Add Gift</button>
        </form>
        <div style="display:flex; align-items:center; gap:12px; margin:4px 0 12px 0; flex-wrap:wrap;" id="multiSelectBar">
          <button type="button" id="multiSelectToggle" class="btn-secondary" style="font-size:13px; padding:8px 12px;">Select Multiple</button>
          <div id="multiSelectActions" style="display:none; gap:8px; align-items:center; flex-wrap:wrap;">
            <span id="multiSelectCount" style="font-size:12px; opacity:.75;">0 selected</span>
            <button type="button" id="multiDeleteBtn" class="btn-delete" style="padding:8px 12px; font-size:13px;">Delete Selected</button>
            <button type="button" id="multiCancelBtn" class="btn-secondary" style="font-size:13px; padding:8px 12px;">Cancel</button>
          </div>
        </div>
        <div id="myGiftsList" class="gifts-list"></div>
      </div>
    </div>
  </div>

  <!-- Kids Gift List Modal -->
  <div id="kidsGiftListModal" class="modal modal--wide">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Kids Gift Lists</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="kidSelector">Which child are these for?</label>
          <select id="kidSelector">
            <option value="">Select a child...</option>
          </select>
        </div>
        <div id="selectedKidGifts" class="gifts-list"></div>
      </div>
    </div>
  </div>

  <!-- Recipient Gifts Modal -->
  <div id="recipientGiftsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="recipientHeader">Recipient's Gift Ideas</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="recipientGiftsList" class="gifts-list"></div>
      </div>
    </div>
  </div>

  <!-- Shopping List Modal -->
  <div id="shoppingListModal" class="modal modal--wide">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Shopping List</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="shoppingListContainer" class="gifts-list"></div>
      </div>
    </div>
  </div>

  <!-- Set Recipient Modal -->
  <div id="setRecipientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Set Recipient</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="recipientStatus" class="helper-text"></div>
        <div class="form-group">
          <label for="recipientSelect">Choose recipient:</label>
          <select id="recipientSelect">
            <option value="">Select a person...</option>
          </select>
        </div>
        <button id="saveRecipientBtn" class="btn-primary">Save Recipient</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="settingsForm" class="settings-form">
          <label class="setting-item">
            <input type="checkbox" id="settingPinSidebar">
            Pin sidebar by default
          </label>
          <div class="setting-item">
            <label for="settingTheme" style="margin: 0;">Theme</label>
            <select id="settingTheme">
              <option value="system">System theme</option>
              <option value="light">Light theme</option>
              <option value="dark">Dark theme</option>
            </select>
          </div>
          <div class="helper-text">These settings are saved on this device.</div>
          <button type="submit" class="btn-primary" style="margin-top:10px;">Save Settings</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <div id="welcomeBanner" class="welcome-banner">
      <h1 class="brand-title">Secret Santa</h1>
      <span id="welcomeMessage"></span>
    </div>


  <div class="main-forms-container">
    <!-- Adult Gift Form -->
    <form id="adultGiftForm" class="gift-form adult-form">
      <h3 class="form-title">Your Gift Ideas</h3>
      <p class="helper-text">Add gift ideas you would like to receive. Switch to Link for a specific product. Auto-detect will switch when a URL is detected.</p>
      <div class="form-group" style="display:flex;align-items:center;gap:12px;margin:8px 0 14px 0;">
        <label style="font-weight:600;">Add as:</label>
        <div class="segmented" id="giftModeToggle" role="radiogroup" aria-label="Add as" data-mode="idea">
          <span class="segmented-indicator"></span>
          <button type="button" class="segment" data-mode="idea" role="radio" aria-checked="true">Idea</button>
          <button type="button" class="segment" data-mode="link" role="radio" aria-checked="false">Link</button>
        </div>
        <input type="hidden" id="giftModeHidden" value="idea">
      </div>
      <div id="ideaFields">
        <label for="adultGiftIdeas">Gift Ideas (one per line):</label>
  <textarea id="adultGiftIdeas" rows="10" required></textarea>
        <div id="autoDetectNote" class="auto-detect-note hide">Detected a link. Switched to Link mode. You can switch back.</div>
      </div>
      <div id="linkFields" style="display:none;">
        <label for="devLinkUrl">Product link (http/https):</label>
        <input type="url" id="devLinkUrl" pattern="https?://.*">
        <label for="devLinkCaption" style="margin-top:8px;">Optional caption/title:</label>
        <input type="text" id="devLinkCaption">
      </div>
      <button type="submit" class="submit-btn">Add My Gift Ideas</button>
    </form>

    <!-- Kids Gift Form -->
    <form id="kidsGiftForm" class="gift-form kids-form">
      <h3 class="form-title">Suggest Gift Ideas for Kids</h3>
      <p class="helper-text">Help build a gift suggestion list for the little ones! Other family members can use these ideas for shopping.</p>
      
      <div class="form-group">
        <label for="childSelect">Which child are these ideas for?</label>
        <select id="childSelect" name="childName" required>
          <option value="">Select a child...</option>
        </select>
        <button type="button" id="addChildBtn" class="btn-secondary" style="margin-left:8px">+ Add child</button>
      </div>

      <!-- Kids submission mode toggle (segmented style) -->
      <div class="form-group" style="margin:8px 0 14px 0; display:flex;align-items:center;gap:12px;">
        <label style="font-weight:600;">Add as:</label>
        <div class="segmented" id="kidsModeToggle" role="radiogroup" aria-label="Add as" data-mode="idea">
          <span class="segmented-indicator"></span>
          <button type="button" class="segment" data-mode="idea" role="radio" aria-checked="true">Idea</button>
          <button type="button" class="segment" data-mode="link" role="radio" aria-checked="false">Link</button>
        </div>
        <input type="hidden" id="kidsModeHidden" value="idea">
      </div>
      <div id="devKidsIdeaFields" class="form-group">
        <label for="kidsGiftIdeas">Gift Ideas for Selected Child:</label>
        <textarea id="kidsGiftIdeas" name="giftIdeas" rows="4" placeholder="Enter gift suggestions for this child (one per line)...&#13;&#10;Examples:&#13;&#10;- Dinosaur toys&#13;&#10;- Size 4T winter clothes&#13;&#10;- Educational books&#13;&#10;- Favorite characters: Paw Patrol, PJ Masks" required></textarea>
      </div>
      <div id="devKidsLinkFields" class="form-group" style="display:none;">
        <label for="devKidLinkUrl">Product link (http/https):</label>
        <input type="url" id="devKidLinkUrl" pattern="https?://.*">
        <label for="devKidLinkCaption" style="margin-top:8px;">Optional caption/title:</label>
        <input type="text" id="devKidLinkCaption">
      </div>

      <div class="tips-section">
        <h4 class="tips-title">Helpful details to include:</h4>
        <ul>
          <li>Sizes for clothes/shoes</li>
          <li>Favorite characters or themes</li>
          <li>Specific toys or brands they like</li>
        </ul>
      </div>

      <button type="submit" class="submit-btn">Add Gift Suggestions</button>
    </form>
  </div>

  <!-- SVG Icons Container -->
  <div class="svg-container">
    <object type="image/svg+xml" data="sidebar-icons.svg"></object>
  </div>

  <!-- Environment Variables (Replace these with your Supabase project values) -->
  <script>
    window.env = {
      SUPABASE_URL: 'your-supabase-url',
      SUPABASE_KEY: 'your-supabase-key'
    };
  </script>

  <!-- Application Scripts -->
  <script type="module" src="auth.js"></script>
  <!-- Production script: link mode, link cards, edit modal, claim/unclaim (includes offline fallback) -->
  <script type="module">
    import { supabase, addGiftToList, getCurrentUser, getMyGifts, addKidGift, getKidGifts, deleteKidGift, getKids, findOrCreateKid } from './supabase.js';
    import { showToast, confirmDialog, editGiftDialog, inputDialog } from './ui.js';

  const adultForm = document.getElementById('adultGiftForm');
  const giftModeToggle = document.getElementById('giftModeToggle');
  const giftModeHidden = document.getElementById('giftModeHidden');
  const ideaTextarea = document.getElementById('adultGiftIdeas');
  const linkFields = document.getElementById('linkFields');
  const ideaFields = document.getElementById('ideaFields');
  const urlInput = document.getElementById('devLinkUrl');
  const captionInput = document.getElementById('devLinkCaption');
  const autoDetectNote = document.getElementById('autoDetectNote');
    const myGiftListBtn = document.getElementById('myGiftList');
    const myGiftsList = document.getElementById('myGiftsList');
  const kidsForm = document.getElementById('kidsGiftForm');
  const childSelect = document.getElementById('childSelect');
  const addChildBtn = document.getElementById('addChildBtn');
    const kidsListBtn = document.getElementById('kidsGiftList');
    const kidSelectorInModal = document.getElementById('kidSelector');
    const selectedKidGifts = document.getElementById('selectedKidGifts');
  const kidsModeToggle = document.getElementById('kidsModeToggle');
  const kidsModeHidden = document.getElementById('kidsModeHidden');
    const kidsIdeaFields = document.getElementById('devKidsIdeaFields');
    const kidsLinkFields = document.getElementById('devKidsLinkFields');
    const kidUrlInput = document.getElementById('devKidLinkUrl');
    const kidCaptionInput = document.getElementById('devKidLinkCaption');
    const kidsTextarea = document.getElementById('kidsGiftIdeas');

    function setGiftMode(mode, {auto=false}={}) {
      giftModeHidden.value = mode;
      giftModeToggle.dataset.mode = mode;
      giftModeToggle.querySelectorAll('.segment').forEach(btn=>{
        btn.setAttribute('aria-checked', btn.dataset.mode===mode ? 'true':'false');
      });
      if (mode==='idea') { ideaFields.style.display=''; linkFields.style.display='none'; urlInput.required=false; ideaTextarea.required=true; }
      else { ideaFields.style.display='none'; linkFields.style.display=''; urlInput.required=true; ideaTextarea.required=false; }
      if (auto) { autoDetectNote?.classList.remove('hide'); setTimeout(()=>autoDetectNote?.classList.add('hide'), 3200); }
      else { autoDetectNote?.classList.add('hide'); }
    }
    giftModeToggle?.addEventListener('click', e=>{ const btn=e.target.closest('.segment'); if(!btn) return; setGiftMode(btn.dataset.mode); });
    giftModeToggle?.addEventListener('keydown', e=>{ if(!['ArrowLeft','ArrowRight'].includes(e.key)) return; e.preventDefault(); const next = giftModeHidden.value==='idea'?'link':'idea'; setGiftMode(next); giftModeToggle.querySelector(`.segment[data-mode="${next}"]`)?.focus(); });
    setGiftMode('idea');

    // Auto-detect URL in idea textarea (single line or line with caption + url)
    const endUrlRegex = /(https?:\/\/[^\s]+)$/i;
    ideaTextarea?.addEventListener('input', () => {
      const val = ideaTextarea.value.trim();
      if (!val) { ideaTextarea.classList.remove('url-invalid'); return; }
      if (!val.includes('\n')) { // single line
        const m = val.match(endUrlRegex);
        if (m) {
          const url = m[1];
          const caption = val.slice(0, val.lastIndexOf(url)).trim();
            // switch to link mode
          setGiftMode('link', {auto:true});
          urlInput.value = url;
          captionInput.value = caption;
          ideaTextarea.value='';
        }
      }
    });

    function normalizeUrl(inputUrl) { try { const u = new URL(inputUrl); if (!/^https?:$/.test(u.protocol)) return null; const strip=[/^utm_/i,/^fbclid$/i,/^gclid$/i,/^igshid$/i,/^mc_eid$/i,/^mc_cid$/i,/^ref$/i]; [...u.searchParams.keys()].forEach(k=>{ if(strip.some(r=>r.test(k))) u.searchParams.delete(k);}); const host=u.hostname.replace(/^www\./,''); if(host.includes('amazon.')){ const m=u.pathname.match(/(?:dp|gp\/product)\/([A-Z0-9]{10})/i)||u.pathname.match(/\/([A-Z0-9]{10})(?:[/?]|$)/i); if(m&&m[1]){ u.pathname=`/dp/${m[1].toUpperCase()}`; u.search=''; } u.searchParams.delete('tag'); } u.protocol='https:'; return u.toString(); } catch{ return null; } }

    // (Removed legacy adult link-only submit handler & mode radio logic)

    // Kids: segmented mode logic
    function getSelectedKidsMode(){ return kidsModeHidden?.value || 'idea'; }
    function setKidsModeUI(mode){
      if(!kidsIdeaFields||!kidsLinkFields) return;
      kidsModeHidden.value = mode;
      kidsModeToggle.dataset.mode = mode;
      kidsModeToggle.querySelectorAll('.segment').forEach(btn=>{
        btn.setAttribute('aria-checked', btn.dataset.mode===mode ? 'true':'false');
      });
      if(mode==='link'){
        kidsIdeaFields.style.display='none';
        kidsLinkFields.style.display='';
        if(kidsTextarea) kidsTextarea.required=false;
        if(kidUrlInput) kidUrlInput.required=true;
      } else {
        kidsIdeaFields.style.display='';
        kidsLinkFields.style.display='none';
        if(kidsTextarea) kidsTextarea.required=true;
        if(kidUrlInput) kidUrlInput.required=false;
      }
    }
    kidsModeToggle?.addEventListener('click', e=>{ const btn=e.target.closest('.segment'); if(!btn) return; setKidsModeUI(btn.dataset.mode); });
    kidsModeToggle?.addEventListener('keydown', e=>{ if(!['ArrowLeft','ArrowRight'].includes(e.key)) return; e.preventDefault(); const next = getSelectedKidsMode()==='idea'?'link':'idea'; setKidsModeUI(next); kidsModeToggle.querySelector(`.segment[data-mode="${next}"]`)?.focus(); });
    setKidsModeUI('idea');

    // Populate kids in main form (moved from app.js)
    async function populateKidsMain() {
      try {
        const kids = await getKids();
        while (childSelect.options.length > 1) childSelect.remove(1);
        kids.forEach(k => {
          const opt = document.createElement('option');
          opt.value = k.id;
          opt.textContent = k.name;
          childSelect.appendChild(opt);
        });
      } catch (e) {
        console.error('Failed to load kids', e);
      }
    }
    await populateKidsMain();

    // "+ Add child" in main form
    addChildBtn?.addEventListener('click', async () => {
      const name = await inputDialog({ title: 'Add Child', label: "Child's name", placeholder: 'e.g., Emma', confirmText: 'Add Child' });
      if (!name) return;
      try {
        const kid = await findOrCreateKid(name);
        await populateKidsMain();
        childSelect.value = kid.id;
        showToast('Child added');
      } catch (e) {
        console.error('Failed to add child', e);
        showToast('Failed to add child', 'error');
      }
    });

    // Kids gift suggestions submit (supports Idea + Link modes)
    kidsForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const kidId = childSelect.value;
      if (!kidId) { showToast('Select a child', 'error'); return; }

      const mode = getSelectedKidsMode();

      try {
        if (mode === 'link') {
          const rawUrl = (kidUrlInput.value || '').trim();
          if (!rawUrl) { showToast('Enter a product link', 'error'); return; }
          const normalized = normalizeUrl(rawUrl);
          if (!normalized) {
            showToast('Enter a valid http/https link', 'error');
            kidUrlInput.classList.add('url-invalid');
            return;
          }
          kidUrlInput.classList.remove('url-invalid');
          const caption = (kidCaptionInput.value || '').trim();
          const name = caption || new URL(normalized).hostname.replace(/^www\./, '');
          await addKidGift(kidId, { name, link: normalized });
          kidUrlInput.value = '';
          kidCaptionInput.value = '';
          showToast('Link added');
          window.dispatchEvent(new CustomEvent('kid-gifts-updated', { detail: { kidId } }));
          return;
        }

        // Idea mode (existing behavior)
        const raw = kidsTextarea.value;
        const lines = (raw || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        if (!lines.length) { showToast('Nothing to add', 'error'); return; }
        let successCount = 0;
        for (const line of lines) {
          try {
            await addKidGift(kidId, { name: line });
            successCount++;
          } catch (err) {
            const msg = String(err?.message || '').toLowerCase();
            if (err?.code === '23505' || msg.includes('duplicate key') || msg.includes('already exists')) continue;
            throw err;
          }
        }
        kidsTextarea.value = '';
        window.dispatchEvent(new CustomEvent('kid-gifts-updated', { detail: { kidId } }));
        showToast(successCount > 0 ? 'Suggestions added' : 'No new suggestions (duplicates ignored)');
      } catch (e2) {
        console.error('Failed to add kid suggestions', e2);
        showToast(`Failed to add suggestions: ${e2.message || 'Unknown error'}`, 'error');
      }
    });

    // Adult submit (segmented)
    adultForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = giftModeHidden.value;
      const user = await getCurrentUser().catch(()=>null);
      if (mode === 'idea') {
        const raw = ideaTextarea.value.trim();
        if (!raw) { showToast('Add at least one idea', 'error'); return; }
        const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
        if (!lines.length) { showToast('Nothing to add', 'error'); return; }
        if (user && user.id) {
          for (const line of lines) { try { await addGiftToList({ name: line }); } catch(e2){ console.error(e2); } }
        } else {
          const existing = JSON.parse(localStorage.getItem('my_gift_ideas') || '[]');
          lines.forEach(l=> existing.push(l));
          localStorage.setItem('my_gift_ideas', JSON.stringify(existing));
        }
        showToast(`Added ${lines.length} idea${lines.length!==1?'s':''}`);
        ideaTextarea.value='';
      } else { // link mode
        const rawUrl = (urlInput.value||'').trim();
        if (!rawUrl) { showToast('Enter a product link', 'error'); return; }
        const normalized = normalizeUrl(rawUrl);
        if (!normalized) { showToast('Enter a valid http/https link', 'error'); urlInput.classList.add('url-invalid'); return; }
        urlInput.classList.remove('url-invalid');
        const caption = (captionInput.value||'').trim();
        const name = caption || new URL(normalized).hostname.replace(/^www\./,'');
        try {
          if (user && user.id) { await addGiftToList({ name, link: normalized }); }
          else {
            const existing = JSON.parse(localStorage.getItem('my_gift_ideas') || '[]');
            existing.push(caption ? `${caption} (${normalized})` : normalized);
            localStorage.setItem('my_gift_ideas', JSON.stringify(existing));
          }
          showToast('Link added');
          urlInput.value=''; captionInput.value='';
        } catch(err){ console.error(err); showToast('Failed to add link', 'error'); }
      }
      loadMyGifts?.();
    });
    // (Removed obsolete mixed kids handler block that was left after refactor)

    // Helpers for local claims
    function localKeyForKid(k){ return `kid_gifts_local:${k}`; }
    function localClaimKeyForKid(k){ return `kid_gifts_claims:${k}`; }
    function getLocalClaimSet(k){ try{ return new Set(JSON.parse(localStorage.getItem(localClaimKeyForKid(k))||'[]')); }catch{ return new Set(); } }
    function saveLocalClaimSet(k,set){ try{ localStorage.setItem(localClaimKeyForKid(k), JSON.stringify(Array.from(set))); }catch{} }
    function getLocalKidGifts(k){ try{ const arr=JSON.parse(localStorage.getItem(localKeyForKid(k))||'[]'); const claims=getLocalClaimSet(k); return arr.map(n=>{ const raw=String(n); const link=(raw.match(/\((https?:[^)]+)\)$/i)||[])[1]||null; const claimed_by=claims.has(raw)?'local':null; return { id:`local-kid-${k}-${encodeURIComponent(raw)}`, name: raw, link, claimed_by, local_key: raw }; }); }catch{ return []; } }

    function domainFromUrl(h){ try{ return new URL(h).hostname.replace(/^www\./,''); }catch{ return ''; } }

    async function loadMyGiftsProd(){ /* reuse sidebar behavior: trigger refresh */ }

    // Note: Kids modal rendering and actions are handled by sidebar.js to avoid duplicate listeners
  </script>
</body>
</html>
